<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nola Schools Finance Tracker — Built by Emmanuel Igbokwe</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    #controls { text-align: center; margin-bottom: 20px; }
    #controls select, #controls input { margin: 0 10px; }
  </style>

  <script>
    // --- Rounding + Formatting Helpers ---
    function toInt(val) {
      if (val === null || val === undefined) return '';
      if (typeof val === 'number') return Math.round(val);
      var s = String(val).trim();
      if (!s) return '';
      if (s.indexOf('/') >= 0) return s; // keep date strings
      var n = Number(s.replace(/[^0-9.\-]/g, ''));
      return isFinite(n) ? Math.round(n) : s;
    }

    function v(x) {
      return (x === null || x === undefined || x === '') ? '' : toInt(x);
    }

    const MONEY_FIELDS = new Set([
      'restrictedCash','unrestrictedCash','currentAssets','fixedAssets','totalAssets',
      'currentLiabilities','longTermLiabilities','totalLiabilities',
      'unrestrictedFB','restrictedFB','totalFB','totalExpenditures',
      'depreciation','accumulatedDepreciation',
      'totalLocalRevenue','totalStateRevenue','totalFederalRevenue','totalRevenue',
      'totalSalaries','totalEmployeeBenefit','totalProfessionalPurchased',
      'totalPurchasedProperty','totalOtherPurchased','totalSupplies',
      'totalProperty','totalOtherObjects','totalOtherUsesOfFund'
    ]);

    function vField(key, val) {
      const coerced = v(val);
      if (!MONEY_FIELDS.has(key)) return coerced;
      const num = Number(coerced);
      return Number.isFinite(num)
        ? '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 })
        : coerced;
    }

    // --- Consolidated Data Storage ---
    let consolidatedData = [];

    // --- File Upload + Parsing ---
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        // Map of Excel cells to object keys
        const r = {
          school: "School Name", // replace with actual lookup if needed
          quarter: document.getElementById('quarter').value,
          fiscalYear: XLSX.utils.sheet_to_json(sheet, { header: 1 })[1][5], // F2 cell
          restrictedCash: sheet["F21"]?.v,
          unrestrictedCash: sheet["F32"]?.v,
          currentAssets: sheet["F45"]?.v,
          fixedAssets: sheet["F55"]?.v,
          accumulatedDepreciation: sheet["F55"]?.v,
          totalAssets: sheet["F60"]?.v,
          currentLiabilities: sheet["F70"]?.v,
          longTermLiabilities: sheet["F80"]?.v,
          totalLiabilities: sheet["F85"]?.v,
          unrestrictedFB: sheet["F86"]?.v,
          restrictedFB: sheet["F87"]?.v,
          totalFB: sheet["F88"]?.v,
          totalExpenditures: sheet["F89"]?.v,
          depreciation: sheet["F54"]?.v,
          totalLocalRevenue: sheet["I23"]?.v,
          totalStateRevenue: sheet["I39"]?.v,
          totalFederalRevenue: sheet["I75"]?.v,
          totalRevenue: sheet["I80"]?.v,
          totalSalaries: sheet["I90"]?.v,
          totalEmployeeBenefit: sheet["I99"]?.v,
          totalProfessionalPurchased: sheet["I105"]?.v,
          totalPurchasedProperty: sheet["I112"]?.v,
          totalOtherPurchased: sheet["I119"]?.v,
          totalSupplies: sheet["I126"]?.v,
          totalProperty: sheet["I132"]?.v,
          totalOtherObjects: sheet["I138"]?.v,
          totalOtherUsesOfFund: sheet["I143"]?.v
        };

        consolidatedData.push(r);
        updateUI();
        e.target.value = ""; // reset file input for multiple uploads
      };
      reader.readAsArrayBuffer(file);
    }

    // --- Update Preview Table ---
    function updateUI() {
      const table = document.getElementById('preview');
      table.innerHTML = "";

      if (!consolidatedData.length) return;

      const headerRow = document.createElement("tr");
      const headers = [
        'School','Quarter','Fiscal Year',
        'Restricted Cash','Unrestricted Cash',
        'Total Current Assets','Fixed Assets','Total Assets',
        'Current Liabilities','Long Term Liabilities','Total Liabilities',
        'Unrestricted Fund Balance','Restricted Fund Balance','Total Fund Balance',
        'Total Expenditures',
        'Depreciation','Accumulated Depreciation',
        'Total Local Revenue','Total State Revenue','Total Federal Revenue','Total Revenue',
        'Total Salaries','Total Employee Benefit','Total Professional Purchased',
        'Total Purchased Property','Total Other Purchased','Total Supplies',
        'Total Property','Total Other Objects','Total Other Uses of Fund'
      ];
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      consolidatedData.forEach(r => {
        const tr = document.createElement("tr");
        const keys = [
          'school','quarter','fiscalYear',
          'restrictedCash','unrestrictedCash',
          'currentAssets','fixedAssets','totalAssets',
          'currentLiabilities','longTermLiabilities','totalLiabilities',
          'unrestrictedFB','restrictedFB','totalFB',
          'totalExpenditures',
          'depreciation','accumulatedDepreciation',
          'totalLocalRevenue','totalStateRevenue','totalFederalRevenue','totalRevenue',
          'totalSalaries','totalEmployeeBenefit','totalProfessionalPurchased',
          'totalPurchasedProperty','totalOtherPurchased','totalSupplies',
          'totalProperty','totalOtherObjects','totalOtherUsesOfFund'
        ];
        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = vField(k, r[k]);
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    // --- Export to Excel ---
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('btnExport').addEventListener('click', function () {
        if (!consolidatedData.length) {
          alert('No data to export');
          return;
        }

        const headers = [
          'School','Quarter','Fiscal Year',
          'Restricted Cash','Unrestricted Cash',
          'Total Current Assets','Fixed Assets','Total Assets',
          'Current Liabilities','Long Term Liabilities','Total Liabilities',
          'Unrestricted Fund Balance','Restricted Fund Balance','Total Fund Balance',
          'Total Expenditures',
          'Depreciation','Accumulated Depreciation',
          'Total Local Revenue','Total State Revenue','Total Federal Revenue','Total Revenue',
          'Total Salaries','Total Employee Benefit','Total Professional Purchased',
          'Total Purchased Property','Total Other Purchased','Total Supplies',
          'Total Property','Total Other Objects','Total Other Uses of Fund'
        ];

        const keys = [
          'school','quarter','fiscalYear',
          'restrictedCash','unrestrictedCash',
          'currentAssets','fixedAssets','totalAssets',
          'currentLiabilities','longTermLiabilities','totalLiabilities',
          'unrestrictedFB','restrictedFB','totalFB',
          'totalExpenditures',
          'depreciation','accumulatedDepreciation',
          'totalLocalRevenue','totalStateRevenue','totalFederalRevenue','totalRevenue',
          'totalSalaries','totalEmployeeBenefit','totalProfessionalPurchased',
          'totalPurchasedProperty','totalOtherPurchased','totalSupplies',
          'totalProperty','totalOtherObjects','totalOtherUsesOfFund'
        ];

        const rows = consolidatedData.map(r =>
          keys.map(k => vField(k, r[k]))
        );
        const aoa = [headers, ...rows];

        const ws = XLSX.utils.aoa_to_sheet(aoa);
        ws['!cols'] = headers.map(() => ({ wch: 18 }));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Consolidated');

        const now = new Date();
        const ts = (now.getMonth()+1).toString().padStart(2,'0') + '-' +
                   now.getDate().toString().padStart(2,'0') + '-' +
                   now.getFullYear() + '_' +
                   now.getHours().toString().padStart(2,'0') + now.getMinutes().toString().padStart(2,'0');
        XLSX.writeFile(wb, `Nola_School_Finance_Tracking_${ts}.xlsx`);
      });
    });
  </script>
</head>
<body>
  <h1>Nola School Finance Tracker — Built by Emmanuel Igbokwe</h1>

  <div id="controls">
    <label for="quarter">Select Quarter:</label>
    <select id="quarter">
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="Q3">Q3</option>
      <option value="Q4">Q4</option>
    </select>
    <input type="file" id="file" accept=".xlsx, .xls" onchange="handleFile(event)">
    <button id="btnExport">Export Consolidated</button>
  </div>

  <table id="preview"></table>
</body>
</html> 
